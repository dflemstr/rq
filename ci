#!/bin/bash -e

# TODO: Replace with https://sh.rustup.rs when it supports -y and such
rustup_init_url='https://raw.githubusercontent.com/rust-lang-nursery/rustup.rs/master/rustup-init.sh'

function for-target {
    local wanted_target
    wanted_target=$1
    shift

    if [[ "$TARGET" == "$wanted_target" ]]
    then "$@"
    fi
}

function install-musl {
    curl 'http://www.musl-libc.org/releases/musl-1.1.15.tar.gz' | tar xzf -
    cd musl-1.1.15
    ./configure
    make -sj
    sudo make -sj install
}

function ci-install {
    local default_target

    for-target x86_64-unknown-linux-musl install-musl
    for-target i686-unknown-linux-gnu    sudo apt-get -y install gcc-multilib

    curl "$rustup_init_url" -sSf | sh -s -- -y --default-toolchain="$TOOLCHAIN"
    default_target="$(rustup target list | grep default | awk '{print $1}')"
    if [[ "$TARGET" != "$default_target" ]]; then rustup target add "$TARGET"; fi
}

function ci-test {
    serde_protobuf/gen-test
    cargo test --manifest-path serde_protobuf/Cargo.toml --target "$TARGET"
    cargo test --target="$TARGET"
}

function ci-deploy {
    for-target x86-unknown-linux-gnu cargo doc
    cargo build --release --target="$TARGET"
    mkdir -p "target/deploy/$TARGET"
    cp "target/$TARGET/release/rq" "target/deploy/$TARGET/rq"
}

function ci-deploy-gh-pages {
    cd target/doc
    git init
    git config user.email 'nobody@nobody.org'
    git config user.name 'Travis CI'
    git add .
    git commit -m "Generate rustdoc for $TRAVIS_COMMIT"
    git push --force "https://${GITHUB_TOKEN}@github.com/dflemstr/rq.git" master:gh-pages
}

case "$1" in
    install )
        shift; ci-install "$@" ;;
    test )
        shift; ci-test "$@" ;;
    deploy )
        shift; ci-deploy "$@" ;;
    deploy-gh-pages )
        shift; for-target x86-unknown-linux-gnu ci-deploy-gh-pages "$@" ;;
esac
